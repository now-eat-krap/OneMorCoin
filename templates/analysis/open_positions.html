{% extends "base.html" %}

{% block content %}
<h2 class="p-3 text-white mx-1 my-1 px-5" style="margin-bottom:0px; background-color:black; border: 1px solid black; border-radius: 15px;">Analysis</h2>
<div class="container-fluid h-100">
{% include "sidebar.html" %}
  <div style="width:70%; float:left">
    <div class="m-3">
      <h1>Open Positions</h1>
    <div id="table"></div>
    </div>
  </div>
  <div id="loading_open_position" style="width: 100%; height: 100%; top: 0; left: 0; position: fixed; display: none; background: #ededed; opacity: 0.7; z-index: 99; text-align: center;">
    <div id="loading_bar" style=" position: absolute; top: 50%; left: 50%; z-index: 100; transform : translate(-50%, -50%);">
      <img src="/static/image/loading.gif" alt="Loading..." />
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
function updateOpenPosition() {
    $.getJSON('/analysis/open_positions/live', function(data) {
      var html = '';

      for(var i = 0; i < data.info.length; i++){
          if(data.info[i].unrealized_pnl >= 0) { var color = `class="fs-4 mb-1 fw-bold" style="color:#2EBD85;"`; }
          else { var color = `class="fs-4 mb-1 fw-bold" style="color:#F6465D;"`; }

          if(data.info[i].side == "Long") { var side_color = `class="p-2" style="background-color:#132A22; color:#2EBD85; border-radius:10px;"`;}
          else { var side_color = `class="p-2" style="background-color:#33181D; color:#F6465D; border-radius:10px;"`;}
          html += `
              <table class="table table-dark table-borderless caption-top table-sm border" style="width:60%;">
                 <caption class="text-white"><h3>${data.info[i].crypto_currency}:${data.info[i].api_name}</h3></caption>
                 <tr>
                  <td style="width:30%;"><span class="fs-4 mb-0 fw-bold">${data.info[i].symbol}</span> <span ${side_color}>${data.info[i].side}</span><p class="mb-0">${data.info[i].margin_type}  ${data.info[i].leverage}x</p></td>
                  <td style="width:20%;"></td>
                  <td style="width:20%;"></td>
                  <td style="width:30%;"><p class= "text-decoration-underline text-white-50 mb-0">Unrealized PNL (ROI)</p><p ${color}>${data.info[i].unrealized_pnl} (${data.info[i].percentage})</p> </td>
                 </tr>
                 <tr>
                  <td class= "text-decoration-underline text-white-50">Position Size</td>
                  <td class= "text-decoration-underline text-white-50">Entry Price</td>
                  <td class= "text-decoration-underline text-white-50">Mark Price</td>
                  <td class= "text-decoration-underline text-white-50">Liq. Price</td>
                 </tr>
                 <tr>
                  <td>${data.info[i].position_size}</td>
                  <td>${data.info[i].entry_price}</td>
                  <td>${data.info[i].market_price}</td>
                  <td>${data.info[i].liquidation_price}</td>
                 </tr>
               </table>
                 `
      }
      if(html == '') {
          html = "<h4>No Open Positions</h4>";
      }

      $("#table").empty();
      $("#table").append(html);
    });
  }
  $('#loading_open_position').show();

  setTimeout(function() {
    $('#loading_open_position').hide();
  },5000);

  $(document).ready(function () {
    updateOpenPosition();
    setInterval(updateOpenPosition , 1000)
  });
</script>
{% endblock %}
